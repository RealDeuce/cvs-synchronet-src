#include <inttypes.h>
#include <stdlib.h>
#include "utf8_codepages.h"

struct ciolib_cpmap {
	uint32_t	unicode;
	uint8_t		cpchar;
};

struct codepage_def {
	char name[32];
	enum ciolib_codepage cp;
	uint8_t *(*to_utf8)(const char *cp437str, size_t buflen, size_t *outlen, struct codepage_def *cpdef);
	char *(*utf8_to)(const uint8_t *utf8str, char unmapped, size_t buflen, size_t *outlen, struct codepage_def *cpdef);
	uint8_t (*from_unicode_cpoint)(uint32_t cpoint, char unmapped, struct codepage_def *cpdef);
	uint8_t (*from_unicode_cpoint_ext)(uint32_t cpoint, char unmapped, struct codepage_def *cpdef);
	struct ciolib_cpmap *cp_table;
	size_t cp_table_sz;
	uint32_t *cp_unicode_table;
	uint32_t *cp_ext_unicode_table;
};

// Sorted by unicode codepoint...
static struct ciolib_cpmap cp437_table[161] = {
	{0x0000, 0},   {0x00A0, 255}, {0x00A1, 173}, {0x00A2, 155},
	{0x00A3, 156}, {0x00A5, 157}, {0x00A7, 21},  {0x00AA, 166},
	{0x00AB, 174}, {0x00AC, 170}, {0x00B0, 248}, {0x00B1, 241},
	{0x00B2, 253}, {0x00B5, 230}, {0x00B6, 20},  {0x00B7, 250},
	{0x00BA, 167}, {0x00BB, 175}, {0x00BC, 172}, {0x00BD, 171},
	{0x00BF, 168}, {0x00C4, 142}, {0x00C5, 143}, {0x00C6, 146},
	{0x00C7, 128}, {0x00C9, 144}, {0x00D1, 165}, {0x00D6, 153},
	{0x00DC, 154}, {0x00DF, 225}, {0x00E0, 133}, {0x00E1, 160},
	{0x00E2, 131}, {0x00E4, 132}, {0x00E5, 134}, {0x00E6, 145},
	{0x00E7, 135}, {0x00E8, 138}, {0x00E9, 130}, {0x00EA, 136},
	{0x00EB, 137}, {0x00EC, 141}, {0x00ED, 161}, {0x00EE, 140}, 
	{0x00EF, 139}, {0x00F1, 164}, {0x00F2, 149}, {0x00F3, 162},
	{0x00F4, 147}, {0x00F6, 148}, {0x00F7, 246}, {0x00F9, 151},
	{0x00FA, 163}, {0x00FB, 150}, {0x00FC, 129}, {0x00FF, 152},
	{0x0192, 159}, {0x0393, 226}, {0x0398, 233}, {0x03A3, 228},
	{0x03A6, 232}, {0x03A9, 234}, {0x03B1, 224}, {0x03B4, 235},
	{0x03B5, 238}, {0x03C0, 227}, {0x03C3, 229}, {0x03C4, 231},
	{0x03C6, 237}, {0x2022, 7},   {0x203C, 19},  {0x207F, 252},
	{0x20A7, 158}, {0x2190, 27},  {0x2191, 24},  {0x2192, 26},
	{0x2193, 25},  {0x2194, 29},  {0x2195, 18},  {0x21A8, 23},
	{0x2219, 249}, {0x221A, 251}, {0x221E, 236}, {0x221F, 28},
	{0x2229, 239}, {0x2248, 247}, {0x2261, 240}, {0x2264, 243},
	{0x2265, 242}, {0x2310, 169}, {0x2320, 244}, {0x2321, 245},
	{0x2500, 196}, {0x2502, 179}, {0x250C, 218}, {0x2510, 191},
	{0x2514, 192}, {0x2518, 217}, {0x251C, 195}, {0x2524, 180},
	{0x252C, 194}, {0x2534, 193}, {0x253C, 197}, {0x2550, 205},
	{0x2551, 186}, {0x2552, 213}, {0x2553, 214}, {0x2554, 201},
	{0x2555, 184}, {0x2556, 183}, {0x2557, 187}, {0x2558, 212},
	{0x2559, 211}, {0x255A, 200}, {0x255B, 190}, {0x255C, 189},
	{0x255D, 188}, {0x255E, 198}, {0x255F, 199}, {0x2560, 204},
	{0x2561, 181}, {0x2562, 182}, {0x2563, 185}, {0x2564, 209},
	{0x2565, 210}, {0x2566, 203}, {0x2567, 207}, {0x2568, 208},
	{0x2569, 202}, {0x256A, 216}, {0x256B, 215}, {0x256C, 206},
	{0x2580, 223}, {0x2584, 220}, {0x2588, 219}, {0x258C, 221},
	{0x2590, 222}, {0x2591, 176}, {0x2592, 177}, {0x2593, 178},
	{0x25A0, 254}, {0x25AC, 22},  {0x25B2, 30},  {0x25BA, 16},
	{0x25BC, 31},  {0x25C4, 17},  {0x25CB, 9},   {0x25D8, 8},
	{0x25D9, 10},  {0x263A, 1},   {0x263B, 2},   {0x263C, 15},
	{0x2640, 12},  {0x2642, 11},  {0x2660, 6},   {0x2663, 5}, 
	{0x2665, 3},   {0x2666, 4},   {0x266A, 13},  {0x266B, 14},
	{0xfffd, '?'}
};

static uint32_t cp437_ext_table[32] = {
	0x0000, 0x263A, 0x263B, 0x2665, 0x2666, 0x2663, 0x2660, 0x2022,
	0x25D8, 0x25CB, 0x25D9, 0x2642, 0x2640, 0x266A, 0x266B, 0x263C,
	0x25BA, 0x25C4, 0x2195, 0x203C, 0x00B6, 0x00A7, 0x25AC, 0x21A8,
	0x2191, 0x2193, 0x2192, 0x2190, 0x221F, 0x2194, 0x25B2, 0x25BC
};

static uint32_t cp437_unicode_table[128] = {
	0x00C7, 0x00FC, 0x00E9, 0x00E2, 0x00E4, 0x00E0, 0x00E5, 0x00E7, 
	0x00EA, 0x00EB, 0x00E8, 0x00EF, 0x00EE, 0x00EC, 0x00C4, 0x00C5, 
	0x00C9, 0x00E6, 0x00C6, 0x00F4, 0x00F6, 0x00F2, 0x00FB, 0x00F9, 
	0x00FF, 0x00D6, 0x00DC, 0x00A2, 0x00A3, 0x00A5, 0x20A7, 0x0192, 
	0x00E1, 0x00ED, 0x00F3, 0x00FA, 0x00F1, 0x00D1, 0x00AA, 0x00BA, 
	0x00BF, 0x2310, 0x00AC, 0x00BD, 0x00BC, 0x00A1, 0x00AB, 0x00BB, 
	0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x2561, 0x2562, 0x2556, 
	0x2555, 0x2563, 0x2551, 0x2557, 0x255D, 0x255C, 0x255B, 0x2510, 
	0x2514, 0x2534, 0x252C, 0x251C, 0x2500, 0x253C, 0x255E, 0x255F, 
	0x255A, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256C, 0x2567, 
	0x2568, 0x2564, 0x2565, 0x2559, 0x2558, 0x2552, 0x2553, 0x256B, 
	0x256A, 0x2518, 0x250C, 0x2588, 0x2584, 0x258C, 0x2590, 0x2580, 
	0x03B1, 0x00DF, 0x0393, 0x03C0, 0x03A3, 0x03C3, 0x00B5, 0x03C4, 
	0x03A6, 0x0398, 0x03A9, 0x03B4, 0x221E, 0x03C6, 0x03B5, 0x2229, 
	0x2261, 0x00B1, 0x2265, 0x2264, 0x2320, 0x2321, 0x00F7, 0x2248, 
	0x00B0, 0x2219, 0x00B7, 0x221A, 0x207F, 0x00B2, 0x25A0, 0x00A0
};

static struct ciolib_cpmap cp1251_table[159] = {
	{0x00a0, 160}, {0x00a4, 164}, {0x00a6, 166}, {0x00a7,  21},
	{0x00a7, 167}, {0x00a9, 169}, {0x00ab, 171}, {0x00ac, 172},
	{0x00ad, 173}, {0x00ae, 174}, {0x00b0, 176}, {0x00b1, 177},
	{0x00b5, 181}, {0x00b6,  20}, {0x00b6, 182}, {0x00b7, 183},
	{0x00bb, 187}, {0x0401, 168}, {0x0402, 128}, {0x0403, 129},
	{0x0404, 170}, {0x0405, 189}, {0x0406, 178}, {0x0407, 175},
	{0x0408, 163}, {0x0409, 138}, {0x040a, 140}, {0x040b, 142},
	{0x040c, 141}, {0x040e, 161}, {0x040f, 143}, {0x0410, 192},
	{0x0411, 193}, {0x0412, 194}, {0x0413, 195}, {0x0414, 196},
	{0x0415, 197}, {0x0416, 198}, {0x0417, 199}, {0x0418, 200},
	{0x0419, 201}, {0x041a, 202}, {0x041b, 203}, {0x041c, 204},
	{0x041d, 205}, {0x041e, 206}, {0x041f, 207}, {0x0420, 208},
	{0x0421, 209}, {0x0422, 210}, {0x0423, 211}, {0x0424, 212},
	{0x0425, 213}, {0x0426, 214}, {0x0427, 215}, {0x0428, 216},
	{0x0429, 217}, {0x042a, 218}, {0x042b, 219}, {0x042c, 220},
	{0x042d, 221}, {0x042e, 222}, {0x042f, 223}, {0x0430, 224},
	{0x0431, 225}, {0x0432, 226}, {0x0433, 227}, {0x0434, 228},
	{0x0435, 229}, {0x0436, 230}, {0x0437, 231}, {0x0438, 232},
	{0x0439, 233}, {0x043a, 234}, {0x043b, 235}, {0x043c, 236},
	{0x043d, 237}, {0x043e, 238}, {0x043f, 239}, {0x0440, 240},
	{0x0441, 241}, {0x0442, 242}, {0x0443, 243}, {0x0444, 244},
	{0x0445, 245}, {0x0446, 246}, {0x0447, 247}, {0x0448, 248},
	{0x0449, 249}, {0x044a, 250}, {0x044b, 251}, {0x044c, 252},
	{0x044d, 253}, {0x044e, 254}, {0x044f, 255}, {0x0451, 184},
	{0x0452, 144}, {0x0453, 131}, {0x0454, 186}, {0x0455, 190},
	{0x0456, 179}, {0x0457, 191}, {0x0458, 188}, {0x0459, 154},
	{0x045a, 156}, {0x045b, 158}, {0x045c, 157}, {0x045e, 162},
	{0x045f, 159}, {0x0490, 165}, {0x0491, 180}, {0x2013, 150},
	{0x2014, 151}, {0x2018, 145}, {0x2019, 146}, {0x201a, 130},
	{0x201c, 147}, {0x201d, 148}, {0x201e, 132}, {0x2020, 134},
	{0x2021, 135}, {0x2022, 149}, {0x2022,   7}, {0x2026, 133},
	{0x2030, 137}, {0x2039, 139}, {0x203a, 155}, {0x203c,  19},
	{0x20ac, 136}, {0x2116, 185}, {0x2122, 153}, {0x2190,  27},
	{0x2191,  24}, {0x2192,  26}, {0x2193,  25}, {0x2194,  29},
	{0x2195,  18}, {0x21a8,  23}, {0x221f,  28}, {0x25ac,  22},
	{0x25b2,  30}, {0x25ba,  16}, {0x25bc,  31}, {0x25c4,  17},
	{0x25cb,   9}, {0x25d8,   8}, {0x25d9,  10}, {0x263a,   1},
	{0x263b,   2}, {0x263c,  15}, {0x2640,  12}, {0x2642,  11},
	{0x2660,   6}, {0x2663,   5}, {0x2665,   3}, {0x2666,   4},
	{0x266a,  13}, {0x266b,  14}, {0xfffd, '?'}
};

static uint32_t cp1251_unicode_table[128] = {
	0x0402, 0x0403, 0x201a, 0x0453, 0x201e, 0x2026, 0x2020, 0x2021,
	0x20ac, 0x2030, 0x0409, 0x2039, 0x040a, 0x040c, 0x040b, 0x040f,
	0x0452, 0x2018, 0x2019, 0x201c, 0x201d, 0x2022, 0x2013, 0x2014,
	0xfffd, 0x2122, 0x0459, 0x203a, 0x045a, 0x045c, 0x045b, 0x045f,
	0x00a0, 0x040e, 0x045e, 0x0408, 0x00a4, 0x0490, 0x00a6, 0x00a7,
	0x0401, 0x00a9, 0x0404, 0x00ab, 0x00ac, 0x00ad, 0x00ae, 0x0407,
	0x00b0, 0x00b1, 0x0406, 0x0456, 0x0491, 0x00b5, 0x00b6, 0x00b7,
	0x0451, 0x2116, 0x0454, 0x00bb, 0x0458, 0x0405, 0x0455, 0x0457,
	0x0410, 0x0411, 0x0412, 0x0413, 0x0414, 0x0415, 0x0416, 0x0417,
	0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e, 0x041f,
	0x0420, 0x0421, 0x0422, 0x0423, 0x0424, 0x0425, 0x0426, 0x0427,
	0x0428, 0x0429, 0x042a, 0x042b, 0x042c, 0x042d, 0x042e, 0x042f,
	0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437,
	0x0438, 0x0439, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f,
	0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447,
	0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f
};

static struct ciolib_cpmap koi8_r_table[160] = {
	{0x00a0, 154}, {0x00a7,  21}, {0x00a9, 191}, {0x00b0, 156},
	{0x00b2, 157}, {0x00b6,  20}, {0x00b7, 158}, {0x00f7, 159},
	{0x0401, 179}, {0x0410, 225}, {0x0411, 226}, {0x0412, 247},
	{0x0413, 231}, {0x0414, 228}, {0x0415, 229}, {0x0416, 246},
	{0x0417, 250}, {0x0418, 233}, {0x0419, 234}, {0x041a, 235},
	{0x041b, 236}, {0x041c, 237}, {0x041d, 238}, {0x041e, 239},
	{0x041f, 240}, {0x0420, 242}, {0x0421, 243}, {0x0422, 244},
	{0x0423, 245}, {0x0424, 230}, {0x0425, 232}, {0x0426, 227},
	{0x0427, 254}, {0x0428, 251}, {0x0429, 253}, {0x042a, 255},
	{0x042b, 249}, {0x042c, 248}, {0x042d, 252}, {0x042e, 224},
	{0x042f, 241}, {0x0430, 193}, {0x0431, 194}, {0x0432, 215},
	{0x0433, 199}, {0x0434, 196}, {0x0435, 197}, {0x0436, 214},
	{0x0437, 218}, {0x0438, 201}, {0x0439, 202}, {0x043a, 203},
	{0x043b, 204}, {0x043c, 205}, {0x043d, 206}, {0x043e, 207},
	{0x043f, 208}, {0x0440, 210}, {0x0441, 211}, {0x0442, 212},
	{0x0443, 213}, {0x0444, 198}, {0x0445, 200}, {0x0446, 195},
	{0x0447, 222}, {0x0448, 219}, {0x0449, 221}, {0x044a, 223},
	{0x044b, 217}, {0x044c, 216}, {0x044d, 220}, {0x044e, 192},
	{0x044f, 209}, {0x0451, 163}, {0x2022,   7}, {0x203c,  19},
	{0x2190,  27}, {0x2191,  24}, {0x2192,  26}, {0x2193,  25},
	{0x2194,  29}, {0x2195,  18}, {0x21a8,  23}, {0x2219, 149},
	{0x221a, 150}, {0x221f,  28}, {0x2248, 151}, {0x2264, 152},
	{0x2265, 153}, {0x2320, 147}, {0x2321, 155}, {0x2500, 128},
	{0x2502, 129}, {0x250c, 130}, {0x2510, 131}, {0x2514, 132},
	{0x2518, 133}, {0x251c, 134}, {0x2524, 135}, {0x252c, 136},
	{0x2534, 137}, {0x253c, 138}, {0x2550, 160}, {0x2551, 161},
	{0x2552, 162}, {0x2553, 164}, {0x2554, 165}, {0x2555, 166},
	{0x2556, 167}, {0x2557, 168}, {0x2558, 169}, {0x2559, 170},
	{0x255a, 171}, {0x255b, 172}, {0x255c, 173}, {0x255d, 174},
	{0x255e, 175}, {0x255f, 176}, {0x2560, 177}, {0x2561, 178},
	{0x2562, 180}, {0x2563, 181}, {0x2564, 182}, {0x2565, 183},
	{0x2566, 184}, {0x2567, 185}, {0x2568, 186}, {0x2569, 187},
	{0x256a, 188}, {0x256b, 189}, {0x256c, 190}, {0x2580, 139},
	{0x2584, 140}, {0x2588, 141}, {0x258c, 142}, {0x2590, 143},
	{0x2591, 144}, {0x2592, 145}, {0x2593, 146}, {0x25a0, 148},
	{0x25ac,  22}, {0x25b2,  30}, {0x25ba,  16}, {0x25bc,  31},
	{0x25c4,  17}, {0x25cb,   9}, {0x25d8,   8}, {0x25d9,  10},
	{0x263a,   1}, {0x263b,   2}, {0x263c,  15}, {0x2640,  12},
	{0x2642,  11}, {0x2660,   6}, {0x2663,   5}, {0x2665,   3},
	{0x2666,   4}, {0x266a,  13}, {0x266b,  14}, {0xfffd, '?'}
};

static uint32_t koi8_r_unicode_table[128] = {
	0x2500, 0x2502, 0x250c, 0x2510, 0x2514, 0x2518, 0x251c, 0x2524,
	0x252c, 0x2534, 0x253c, 0x2580, 0x2584, 0x2588, 0x258c, 0x2590,
	0x2591, 0x2592, 0x2593, 0x2320, 0x25a0, 0x2219, 0x221a, 0x2248,
	0x2264, 0x2265, 0x00a0, 0x2321, 0x00b0, 0x00b2, 0x00b7, 0x00f7,
	0x2550, 0x2551, 0x2552, 0x0451, 0x2553, 0x2554, 0x2555, 0x2556,
	0x2557, 0x2558, 0x2559, 0x255a, 0x255b, 0x255c, 0x255d, 0x255e,
	0x255f, 0x2560, 0x2561, 0x0401, 0x2562, 0x2563, 0x2564, 0x2565,
	0x2566, 0x2567, 0x2568, 0x2569, 0x256a, 0x256b, 0x256c, 0x00a9,
	0x044e, 0x0430, 0x0431, 0x0446, 0x0434, 0x0435, 0x0444, 0x0433,
	0x0445, 0x0438, 0x0439, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e,
	0x043f, 0x044f, 0x0440, 0x0441, 0x0442, 0x0443, 0x0436, 0x0432,
	0x044c, 0x044b, 0x0437, 0x0448, 0x044d, 0x0449, 0x0447, 0x044a,
	0x042e, 0x0410, 0x0411, 0x0426, 0x0414, 0x0415, 0x0424, 0x0413,
	0x0425, 0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e,
	0x041f, 0x042f, 0x0420, 0x0421, 0x0422, 0x0423, 0x0416, 0x0412,
	0x042c, 0x042b, 0x0417, 0x0428, 0x042d, 0x0429, 0x0427, 0x042a
};

static uint32_t empty_ext_table[32] = {
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd
};

static struct ciolib_cpmap iso8859_2_table[128] = {
	{0x00a0, 160}, {0x00a4, 164}, {0x00a7, 167}, {0x00a7,  21},
	{0x00a8, 168}, {0x00ad, 173}, {0x00b0, 176}, {0x00b4, 180},
	{0x00b6,  20}, {0x00b8, 184}, {0x00c1, 193}, {0x00c2, 194},
	{0x00c4, 196}, {0x00c7, 199}, {0x00c9, 201}, {0x00cb, 203},
	{0x00cd, 205}, {0x00ce, 206}, {0x00d3, 211}, {0x00d4, 212},
	{0x00d6, 214}, {0x00d7, 215}, {0x00da, 218}, {0x00dc, 220},
	{0x00dd, 221}, {0x00df, 223}, {0x00e1, 225}, {0x00e2, 226},
	{0x00e4, 228}, {0x00e7, 231}, {0x00e9, 233}, {0x00eb, 235},
	{0x00ed, 237}, {0x00ee, 238}, {0x00f3, 243}, {0x00f4, 244},
	{0x00f6, 246}, {0x00f7, 247}, {0x00fa, 250}, {0x00fc, 252},
	{0x00fd, 253}, {0x0102, 195}, {0x0103, 227}, {0x0104, 161},
	{0x0105, 177}, {0x0106, 198}, {0x0107, 230}, {0x010c, 200},
	{0x010d, 232}, {0x010e, 207}, {0x010f, 239}, {0x0110, 208},
	{0x0111, 240}, {0x0118, 202}, {0x0119, 234}, {0x011a, 204},
	{0x011b, 236}, {0x0139, 197}, {0x013a, 229}, {0x013d, 165},
	{0x013e, 181}, {0x0141, 163}, {0x0142, 179}, {0x0143, 209},
	{0x0144, 241}, {0x0147, 210}, {0x0148, 242}, {0x0150, 213},
	{0x0151, 245}, {0x0154, 192}, {0x0155, 224}, {0x0158, 216},
	{0x0159, 248}, {0x015a, 166}, {0x015b, 182}, {0x015e, 170},
	{0x015f, 186}, {0x0160, 169}, {0x0161, 185}, {0x0162, 222},
	{0x0163, 254}, {0x0164, 171}, {0x0165, 187}, {0x016e, 217},
	{0x016f, 249}, {0x0170, 219}, {0x0171, 251}, {0x0179, 172},
	{0x017a, 188}, {0x017b, 175}, {0x017c, 191}, {0x017d, 174},
	{0x017e, 190}, {0x02c7, 183}, {0x02d8, 162}, {0x02d9, 255},
	{0x02db, 178}, {0x02dd, 189}, {0x2022,   7}, {0x203c,  19},
	{0x2190,  27}, {0x2191,  24}, {0x2192,  26}, {0x2193,  25},
	{0x2194,  29}, {0x2195,  18}, {0x21a8,  23}, {0x221f,  28},
	{0x25ac,  22}, {0x25b2,  30}, {0x25ba,  16}, {0x25bc,  31},
	{0x25c4,  17}, {0x25cb,   9}, {0x25d8,   8}, {0x25d9,  10},
	{0x263a,   1}, {0x263b,   2}, {0x263c,  15}, {0x2640,  12},
	{0x2642,  11}, {0x2660,   6}, {0x2663,   5}, {0x2665,   3},
	{0x2666,   4}, {0x266a,  13}, {0x266b,  14}, {0xfffd,   0}
};

static uint32_t iso8859_2_unicode_table[128] = {
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0x00a0, 0x0104, 0x02d8, 0x0141, 0x00a4, 0x013d, 0x015a, 0x00a7,
	0x00a8, 0x0160, 0x015e, 0x0164, 0x0179, 0x00ad, 0x017d, 0x017b,
	0x00b0, 0x0105, 0x02db, 0x0142, 0x00b4, 0x013e, 0x015b, 0x02c7,
	0x00b8, 0x0161, 0x015f, 0x0165, 0x017a, 0x02dd, 0x017e, 0x017c,
	0x0154, 0x00c1, 0x00c2, 0x0102, 0x00c4, 0x0139, 0x0106, 0x00c7,
	0x010c, 0x00c9, 0x0118, 0x00cb, 0x011a, 0x00cd, 0x00ce, 0x010e,
	0x0110, 0x0143, 0x0147, 0x00d3, 0x00d4, 0x0150, 0x00d6, 0x00d7,
	0x0158, 0x016e, 0x00da, 0x0170, 0x00dc, 0x00dd, 0x0162, 0x00df,
	0x0155, 0x00e1, 0x00e2, 0x0103, 0x00e4, 0x013a, 0x0107, 0x00e7,
	0x010d, 0x00e9, 0x0119, 0x00eb, 0x011b, 0x00ed, 0x00ee, 0x010f,
	0x0111, 0x0144, 0x0148, 0x00f3, 0x00f4, 0x0151, 0x00f6, 0x00f7,
	0x0159, 0x016f, 0x00fa, 0x0171, 0x00fc, 0x00fd, 0x0163, 0x02d9
};

static struct ciolib_cpmap iso8859_4_table[128] = {
	{0x00a0, 160}, {0x00a4, 164}, {0x00a7,  21}, {0x00a7, 167},
	{0x00a8, 168}, {0x00ad, 173}, {0x00af, 175}, {0x00b0, 176},
	{0x00b4, 180}, {0x00b6,  20}, {0x00b8, 184}, {0x00c1, 193},
	{0x00c2, 194}, {0x00c3, 195}, {0x00c4, 196}, {0x00c5, 197},
	{0x00c6, 198}, {0x00c9, 201}, {0x00cb, 203}, {0x00cd, 205},
	{0x00ce, 206}, {0x00d4, 212}, {0x00d5, 213}, {0x00d6, 214},
	{0x00d7, 215}, {0x00d8, 216}, {0x00da, 218}, {0x00db, 219},
	{0x00dc, 220}, {0x00df, 223}, {0x00e1, 225}, {0x00e2, 226},
	{0x00e3, 227}, {0x00e4, 228}, {0x00e5, 229}, {0x00e6, 230},
	{0x00e9, 233}, {0x00eb, 235}, {0x00ed, 237}, {0x00ee, 238},
	{0x00f4, 244}, {0x00f5, 245}, {0x00f6, 246}, {0x00f7, 247},
	{0x00f8, 248}, {0x00fa, 250}, {0x00fb, 251}, {0x00fc, 252},
	{0x0100, 192}, {0x0101, 224}, {0x0104, 161}, {0x0105, 177},
	{0x010c, 200}, {0x010d, 232}, {0x0110, 208}, {0x0111, 240},
	{0x0112, 170}, {0x0113, 186}, {0x0116, 204}, {0x0117, 236},
	{0x0118, 202}, {0x0119, 234}, {0x0122, 171}, {0x0123, 187},
	{0x0128, 165}, {0x0129, 181}, {0x012a, 207}, {0x012b, 239},
	{0x012e, 199}, {0x012f, 231}, {0x0136, 211}, {0x0137, 243},
	{0x0138, 162}, {0x013b, 166}, {0x013c, 182}, {0x0145, 209},
	{0x0146, 241}, {0x014a, 189}, {0x014b, 191}, {0x014c, 210},
	{0x014d, 242}, {0x0156, 163}, {0x0157, 179}, {0x0160, 169},
	{0x0161, 185}, {0x0166, 172}, {0x0167, 188}, {0x0168, 221},
	{0x0169, 253}, {0x016a, 222}, {0x016b, 254}, {0x0172, 217},
	{0x0173, 249}, {0x017d, 174}, {0x017e, 190}, {0x02c7, 183},
	{0x02d9, 255}, {0x02db, 178}, {0x2022,   7}, {0x203c,  19},
	{0x2190,  27}, {0x2191,  24}, {0x2192,  26}, {0x2193,  25},
	{0x2194,  29}, {0x2195,  18}, {0x21a8,  23}, {0x221f,  28},
	{0x25ac,  22}, {0x25b2,  30}, {0x25ba,  16}, {0x25bc,  31},
	{0x25c4,  17}, {0x25cb,   9}, {0x25d8,   8}, {0x25d9,  10},
	{0x263a,   1}, {0x263b,   2}, {0x263c,  15}, {0x2640,  12},
	{0x2642,  11}, {0x2660,   6}, {0x2663,   5}, {0x2665,   3},
	{0x2666,   4}, {0x266a,  13}, {0x266b,  14}, {0xfffd, '?'}
};

static uint32_t iso8859_4_unicode_table[128] = {
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd, 0xfffd,
	0x00a0, 0x0104, 0x0138, 0x0156, 0x00a4, 0x0128, 0x013b, 0x00a7,
	0x00a8, 0x0160, 0x0112, 0x0122, 0x0166, 0x00ad, 0x017d, 0x00af,
	0x00b0, 0x0105, 0x02db, 0x0157, 0x00b4, 0x0129, 0x013c, 0x02c7,
	0x00b8, 0x0161, 0x0113, 0x0123, 0x0167, 0x014a, 0x017e, 0x014b,
	0x0100, 0x00c1, 0x00c2, 0x00c3, 0x00c4, 0x00c5, 0x00c6, 0x012e,
	0x010c, 0x00c9, 0x0118, 0x00cb, 0x0116, 0x00cd, 0x00ce, 0x012a,
	0x0110, 0x0145, 0x014c, 0x0136, 0x00d4, 0x00d5, 0x00d6, 0x00d7,
	0x00d8, 0x0172, 0x00da, 0x00db, 0x00dc, 0x0168, 0x016a, 0x00df,
	0x0101, 0x00e1, 0x00e2, 0x00e3, 0x00e4, 0x00e5, 0x00e6, 0x012f,
	0x010d, 0x00e9, 0x0119, 0x00eb, 0x0117, 0x00ed, 0x00ee, 0x012b,
	0x0111, 0x0146, 0x014d, 0x0137, 0x00f4, 0x00f5, 0x00f6, 0x00f7,
	0x00f8, 0x0173, 0x00fa, 0x00fb, 0x00fc, 0x0169, 0x016b, 0x02d9
};

static int
cmptab(const void *key, const void *entry)
{
	const uint32_t *pkey = key;
	const struct ciolib_cpmap *pentry = entry;

	if (*pkey == pentry->unicode)
		return 0;
	if (*pkey < pentry->unicode)
		return -1;
	return 1;
}

static uint8_t
cptable_from_unicode_cpoint(uint32_t cpoint, char unmapped, struct codepage_def *cpdef)
{
	struct ciolib_cpmap *mapped;

	if (cpoint < 128)
		return cpoint;
	mapped = bsearch(&cpoint, cpdef->cp_table, cpdef->cp_table_sz, sizeof(cpdef->cp_table[0]), cmptab);
	if (mapped == NULL)
		return unmapped;
	return mapped->cpchar;
}

static uint8_t
cptable_from_unicode_cpoint_ext(uint32_t cpoint, char unmapped, struct codepage_def *cpdef)
{
	if (cpoint < 32) {
		return cpdef->cp_ext_unicode_table[cpoint];
	}
	return cptable_from_unicode_cpoint(cpoint, unmapped, cpdef);
}

static int
write_cp(uint8_t *str, uint32_t cp)
{
	if (cp < 128) {
		*str = cp;
		return 1;
	}
	if (cp < 0x800) {
		*(str++) = 0xc0 | (cp >> 6);
		*(str++) = 0x80 | (cp & 0x3f);
		return 2;
	}
	if (cp < 0x10000) {
		*(str++) = 0xe0 | (cp >> 12);
		*(str++) = 0x80 | ((cp >> 6) & 0x3f);
		*(str++) = 0x80 | (cp & 0x3f);
		return 3;
	}
	if (cp < 0x110000) {
		*(str++) = 0xf0 | (cp >> 18);
		*(str++) = 0x80 | ((cp >> 12) & 0x3f);
		*(str++) = 0x80 | ((cp >> 6) & 0x3f);
		*(str++) = 0x80 | (cp & 0x3f);
		return 4;
	}
	return -1;
}

static int
read_cp(const uint8_t *str, uint32_t *cp)
{
	int incode;
	const uint8_t *p = str;

	if (cp == NULL)
		goto error;

	if (str == NULL)
		goto error;

	if (*p & 0x80) {
		if ((*p & 0xe0) == 0xc0) {
			incode = 1;
			*cp = *p & 0x1f;
		}
		else if ((*p & 0xf0) == 0xe0) {
			incode = 2;
			*cp = *p & 0x0f;
		}
		else if ((*p & 0xf8) == 0xf0) {
			incode = 3;
			*cp = *p & 0x07;
		}
		else
			goto error;

		while (incode) {
			p++;
			incode--;
			if ((*p & 0xc0) != 0x80)
				goto error;
			*cp <<= 6;
			*cp |= (*p & 0x3f);
		}
	}
	else {
		*cp = *p;
	}
	return p - str + 1;

error:
	if (cp)
		*cp = 0xffff;
	return -1;
}

static int
utf8_bytes(uint32_t cp)
{
	if (cp < 0x80)
		return 1;
	if (cp < 0x800)
		return 2;
	if (cp < 0x10000)
		return 3;
	if (cp < 0x11000)
		return 4;
	return -1;
}

static uint8_t *
cpstr_to_utf8(const char *cpstr, size_t buflen, size_t *outlen, struct codepage_def *cpdef)
{
	size_t needed = 0;
	int cplen;
	uint8_t *ret = NULL;
	uint8_t *rp;
	size_t idx;
	uint8_t ch;

	// Calculate the number of bytes needed
	for (idx = 0; idx < buflen; idx++) {
		ch = cpstr[idx];
		if (ch == 0)
			cplen = 4;
		else if (ch < 128)
			cplen = 1;
		else
			cplen = utf8_bytes(ch - 128);
		if (cplen == -1)
			goto error;
		needed += cplen;
	}

	ret = malloc(needed + 1);
	if (ret == NULL)
		goto error;

	rp = ret;
	for (idx = 0; idx < buflen; idx++) {
		ch = cpstr[idx];
		if (ch == 0) {
			*(rp++) = 0xef;
			*(rp++) = 0xbf;
			*(rp++) = 0xbe;
			cplen = 0;
		}
		else if (ch < 128) {
			*rp = ch;
			cplen = 1;
		}
		else {
			cplen = write_cp(rp, cpdef->cp_unicode_table[ch - 128]);
			if (cplen < 1)
				goto error;
		}
		rp += cplen;
	}
	*rp = 0;
	if (outlen)
		*outlen = rp - ret;
	return ret;

error:
	free(ret);
	return NULL;
}

/*
 * Converts UTF-8 to CP437, replacing unmapped characters with unmapped
 * if unmapped is zero, unmapped characters are stripped.
 * 
 * Returns NULL if there are invalid sequences or codepoints.
 * Does not normalize the unicode, just a simple mapping
 * (TODO: Normalize into combined chars etc)
 */
static char *
utf8_to_cpstr(const uint8_t *utf8str, char unmapped, size_t inlen, size_t *outlen, struct codepage_def *cpdef)
{
	size_t idx;
	char *rp;
	size_t outsz = 0;
	int incode = 0;
	uint32_t codepoint;
	char *ret = NULL;

	// TODO: Normalize UTF-8...

	// Calculate the number of code points and validate.
	for (idx = 0; idx < inlen; idx++) {
		if (incode) {
			switch (utf8str[idx] & 0xc0) {
				case 0x80:
					incode--;
					if (incode == 0)
						outsz++;
					break;
				default:
					goto error;
			}
		}
		else {
			if (utf8str[idx] & 0x80) {
				if ((utf8str[idx] & 0xe0) == 0xc0)
					incode = 1;
				else if ((utf8str[idx] & 0xf0) == 0xe0)
					incode = 2;
				else if ((utf8str[idx] & 0xf8) == 0xf0)
					incode = 3;
				else
					goto error;
			}
			else
				outsz++;
		}
	}
	ret = malloc(outsz + 1);
	if (ret == NULL)
		goto error;
	rp = ret;

	// Fill the string...
	for (idx = 0; idx < inlen; idx++) {
		utf8str += read_cp(&utf8str[idx], &codepoint);
		if (codepoint == 0xffff || codepoint == 0xfffe)
			goto error;
		if (codepoint < 128)
			*(rp++) = codepoint;
		// Multiple representations...
		else if (codepoint == 0xa6) 
			*(rp++) = '|';
		else {
			*(rp++) = cptable_from_unicode_cpoint(codepoint, unmapped, cpdef);
		}
	}
	*rp = 0;
	if (outlen)
		*outlen = rp - ret;

	return ret;
error:
	free(ret);
	return NULL;
}

struct codepage_def ciolib_cp[CIOLIB_CP_COUNT] = {
	{"CP437", CIOLIB_CP437, cpstr_to_utf8, utf8_to_cpstr, cptable_from_unicode_cpoint, cptable_from_unicode_cpoint_ext, 
		cp437_table, sizeof(cp437_table) / sizeof(cp437_table[0]),
		cp437_unicode_table, cp437_ext_table},
	{"CP1251", CIOLIB_CP1251, cpstr_to_utf8, utf8_to_cpstr, cptable_from_unicode_cpoint, cptable_from_unicode_cpoint_ext, 
		cp1251_table, sizeof(cp1251_table) / sizeof(cp1251_table[0]),
		cp1251_unicode_table, cp437_ext_table},
	{"KOI8-R", CIOLIB_KOI8_R, cpstr_to_utf8, utf8_to_cpstr, cptable_from_unicode_cpoint, cptable_from_unicode_cpoint_ext, 
		koi8_r_table, sizeof(koi8_r_table) / sizeof(koi8_r_table[0]),
		koi8_r_unicode_table, empty_ext_table},
	{"ISO-8859-2", CIOLIB_ISO_8859_2, cpstr_to_utf8, utf8_to_cpstr, cptable_from_unicode_cpoint, cptable_from_unicode_cpoint_ext, 
		iso8859_2_table, sizeof(iso8859_2_table) / sizeof(iso8859_2_table[0]),
		iso8859_2_unicode_table, empty_ext_table},
	{"ISO-8859-4", CIOLIB_ISO_8859_4, cpstr_to_utf8, utf8_to_cpstr, cptable_from_unicode_cpoint, cptable_from_unicode_cpoint_ext, 
		iso8859_4_table, sizeof(iso8859_4_table) / sizeof(iso8859_4_table[0]),
		iso8859_4_unicode_table, empty_ext_table},
};

uint8_t *cp_to_utf8(enum ciolib_codepage cp, const char *cpstr, size_t buflen, size_t *outlen)
{
	if (cp < 0 || cp >= CIOLIB_CP_COUNT)
		return NULL;

	return ciolib_cp[cp].to_utf8(cpstr, buflen, outlen, &ciolib_cp[cp]);
}

char *utf8_to_cp(enum ciolib_codepage cp, const uint8_t *utf8str, char unmapped, size_t buflen, size_t *outlen)
{
	if (cp < 0 || cp >= CIOLIB_CP_COUNT)
		return NULL;

	return ciolib_cp[cp].utf8_to(utf8str, unmapped, buflen, outlen, &ciolib_cp[cp]);
}

uint8_t cp_from_unicode_cp(enum ciolib_codepage cp, uint32_t cpoint, char unmapped)
{
	if (cp < 0 || cp >= CIOLIB_CP_COUNT)
		return unmapped;

	return ciolib_cp[cp].from_unicode_cpoint(cpoint, unmapped, &ciolib_cp[cp]);
}

uint8_t cp_from_unicode_cp_ext(enum ciolib_codepage cp, uint32_t cpoint, char unmapped)
{
	if (cp < 0 || cp >= CIOLIB_CP_COUNT)
		return unmapped;

	return ciolib_cp[cp].from_unicode_cpoint_ext(cpoint, unmapped, &ciolib_cp[cp]);
}
